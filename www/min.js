"use strict";const WASM_URI="jset_web.wasm";let debug_chars=new Array;function debug_char(e){10==e?(console.log(debug_chars.join("")),debug_chars=new Array):debug_chars.push(String.fromCharCode(e))}function panique(){console.log("WASM module has panicked.");const e=document.getElementById("panic-background");e.style.zIndex=10,e.style.display="block"}function recursive_clear(e){for(;e.firstChild;)recursive_clear(e.lastChild),e.removeChild(e.lastChild)}var jswmod={};const CANVAS=document.getElementById("demo-canvas"),STATUS={div:document.getElementById("status")};function checksum_buffer(){const e=new Uint8ClampedArray(jswmod.exports.memory.buffer,jswmod.exports.BUFFER.value,8294400);let t=0;for(let n of e)t+=n;return t%1e3}STATUS.show=function(e){STATUS.div.innerHTML=e,STATUS.div.style.display="block"},STATUS.hide=function(){STATUS.div.style.display="none"};const DEFAULT_PARAMS={x_pixels:1200,y_pixels:800,x:-2,y:1,width:3,zoom:2,iter:{type:"mandlebrot"}};let current_params=DEFAULT_PARAMS;function update_canvas(e,t){CANVAS.width=e,CANVAS.height=t;const n=new ImageData(new Uint8ClampedArray(jswmod.exports.memory.buffer,jswmod.exports.IMAGE.value,4*e*t),e);CANVAS.getContext("2d").putImageData(n,0,0)}function render_image(e){STATUS.show("Drawing..."),jswmod.exports.redraw(e.x_pixels,e.y_pixels,e.x,e.y,e.width,"polynomial"==e.iter.type),update_canvas(e.x_pixels,e.y_pixels),STATUS.hide()}function recolor(){STATUS.show("Coloring...");const e=current_params;COLOR.update_map(),update_canvas(e.x_pixels,e.y_pixels),STATUS.hide()}async function init(){STATUS.show("Loading..."),WebAssembly.instantiateStreaming(fetch(WASM_URI),{env:{dbg:debug_char,pnk:panique}}).then(function(e){(jswmod=e.instance).exports.update_color_map(),STATUS.hide(),COLOR.update_map(),render_image(DEFAULT_PARAMS)}).catch(function(e){STATUS.show("Error fetching WASM module; see console."),console.log(e)})}function click_details(e){const t=current_params,n=CANVAS.getBoundingClientRect(),o=(e.x-n.left)/n.width,r=(e.y-n.top)/n.height,s=t.width*t.y_pixels/t.x_pixels;return{x:t.x+o*t.width,y:t.y-r*s,shift:e.shiftKey,ctrl:e.ctrlKey}}function new_params(e){const t=current_params,n=t.width*t.y_pixels/t.x_pixels;let o=1;e.shift?o=t.zoom:e.ctrl&&(o=1/t.zoom);const r=t.width/o,s=n/o,a=e.x-r/2,l=e.y+s/2,i={x_pixels:t.x_pixels,y_pixels:t.y_pixels,x:a,y:l,width:r,zoom:t.zoom,iter:t.iter};return current_params=i,i}function mobile_zoom(e){const t=current_params,n=t.width*t.y_pixels/t.x_pixels;let o,r,s;if(e){const e=(1-1/t.zoom)/2;o=t.x+e*t.width,r=t.y-e*n,s=t.width/t.zoom}else{const e=(t.zoom-1)/2;o=t.x-e*t.width,r=t.y+e*n,s=t.width*t.zoom}const a={x_pixels:t.x_pixels,y_pixels:t.y_pixels,x:o,y:r,width:s,zoom:t.zoom,iter:t.iter};current_params=a,render_image(a)}CANVAS.onclick=function(e){render_image(new_params(click_details(e)))},document.getElementById("m-zoom-in").onclick=function(e){e.preventDefault(),mobile_zoom(!0)},document.getElementById("m-zoom-out").onclick=function(e){e.preventDefault(),mobile_zoom(!1)};const COLOR={MAX_STEPS:16,MAX_SHADES:65534,tbody:document.querySelector("div#color-map table tbody"),add:document.getElementById("add-color"),hexre:/[0-9a-fA-F][0-9a-fA-F]/g,defaults:[["#000000",128,"#ffffff"],["#ffffff",256,"#000000"]]};function add_gradient(e,t,n){const o=document.createElement("tr"),r=document.createElement("td"),s=document.createElement("input");s.type="color",s.setAttribute("class","from"),s.value=e||"#000000",r.appendChild(s),o.appendChild(r);const a=document.createElement("td"),l=document.createElement("input");l.type="number",l.setAttribute("min","0"),l.setAttribute("max","65535"),l.value=t||1,a.appendChild(l),o.appendChild(a);const i=document.createElement("td"),c=document.createElement("input");c.type="color",c.setAttribute("class","to"),c.value=n||"#000000",i.appendChild(c),o.appendChild(i);const d=document.createElement("td"),u=document.createElement("button");u.type="button",u.appendChild(document.createTextNode("[x]")),u.title="remove this color gradient",u.setAttribute("class","remove-gradient"),u.onclick=function(){recursive_clear(o),o.parentElement.removeChild(o)},d.appendChild(u),o.appendChild(d),COLOR.tbody.appendChild(o)}COLOR.to_rgb=function(e){return Array.from(e.matchAll(COLOR.hexre),e=>parseInt(e,16))},COLOR.get_params=function(){const e=Array.from(COLOR.tbody.querySelectorAll("input.from"),e=>COLOR.to_rgb(e.value)),t=Array.from(COLOR.tbody.querySelectorAll("input.to"),e=>COLOR.to_rgb(e.value)),n=Array.from(COLOR.tbody.querySelectorAll('input[type="number"]'),function(e){const t=parseInt(e.value,10);return t>255?255:t<0?0:t}),o={r_starts:new Array,g_starts:new Array,b_starts:new Array,r_ends:new Array,g_ends:new Array,b_ends:new Array,n_steps:n.length,shades:n};for(const t of e)o.r_starts.push(t[0]),o.g_starts.push(t[1]),o.b_starts.push(t[2]);for(const e of t)o.r_ends.push(e[0]),o.g_ends.push(e[1]),o.b_ends.push(e[2]);return o},COLOR.update_map=function(){const e=COLOR.get_params();if(e.n_steps>COLOR.MAX_STEPS)return console.log("Too many steps in color map."),null;if(e.shades.reduce((e,t)=>e+t)>COLOR.MAX_SHADES)return console.log("Too many shades in color map."),null;for(let t=0;t<e.n_steps;t++)jswmod.exports.set_gradient(t,e.r_starts[t],e.g_starts[t],e.b_starts[t],e.r_ends[t],e.g_ends[t],e.b_ends[t],e.shades[t]);jswmod.exports.set_n_gradients(e.n_steps),jswmod.exports.update_color_map();const t=current_params;jswmod.exports.recolor(t.x_pixels,t.y_pixels)};for(const e of COLOR.defaults)add_gradient(e[0],e[1],e[2]);COLOR.current_params=COLOR.get_params(),COLOR.add.onclick=function(e){e.preventDefault();let t="#000000";const n=document.querySelectorAll("input.to");n.length>0&&(t=n[n.length-1].value),add_gradient(t,256,"#000000")};const ITER={select_form:document.getElementById("iter-type"),param_form:document.getElementById("poly-params"),param_div:document.getElementById("polynomial"),rvals:document.querySelectorAll("input.r"),tvals:document.querySelectorAll("input.t")};function switch_iter_type(){"mandlebrot"==new FormData(ITER.select_form).get("iter-pick")?ITER.param_div.style.display="none":ITER.param_div.style.display="flex"}for(let e of document.querySelectorAll('input[name="iter-pick"]'))e.onclick=switch_iter_type;function enable_poly_inputs(){const e=new FormData(ITER.param_form),t=Number(e.get("ncoeff")),n=ITER.rvals.length;for(let e=0;e<t;e++)ITER.rvals[e].disabled=!1,ITER.tvals[e].disabled=!1;for(let e=t;e<n;e++)ITER.rvals[e].disabled=!0,ITER.tvals[e].disabled=!0}for(let e of document.querySelectorAll('input[name="ncoeff"]'))e.onclick=enable_poly_inputs;enable_poly_inputs(),ITER.get_params=function(){if("mandlebrot"==new FormData(ITER.select_form).get("iter-pick"))return{type:"mandlebrot"};const e=new FormData(ITER.param_form),t=Number(e.get("ncoeff")),n=new Array,o=new Array;for(let e=0;e<t;e++){const t=Number(ITER.rvals[e].value),r=Number(ITER.tvals[e].value)*Math.PI;n.push(t*Math.cos(r)),o.push(t*Math.sin(r))}return{type:"polynomial",n:t,re:n,im:o}},ITER.set_params=function(e){if("mandlebrot"!=e.type){for(let t=0;t<e.n;t++)jswmod.exports.set_coeff(t,e.re[t],e.im[t]);jswmod.exports.set_n_coeffs(e.n)}};const CONTROL={div:document.getElementById("control"),open:document.getElementById("control-open"),close:document.getElementById("control-close"),width:document.getElementById("ixpix"),height:document.getElementById("iypix"),outline:document.getElementById("canvas-outline"),zoom_bar:document.getElementById("izbar"),zoom_num:document.getElementById("iznum"),new_x:DEFAULT_PARAMS.x_pixels,new_y:DEFAULT_PARAMS.y_pixels};function resize_canvas_box(){const e=CANVAS.getBoundingClientRect(),t=CONTROL.outline;t.style.top=e.top+"px",t.style.left=e.left+"px",t.style.width=CONTROL.width.value+"px",t.style.height=CONTROL.height.value+"px",t.style.display="inline-block",CONTROL.new_x=parseInt(CONTROL.width.value),CONTROL.new_y=parseInt(CONTROL.height.value)}function set_zoom(e){const t=Number(e.target.value);t&&(current_params.zoom=t,CONTROL.zoom_bar==e.target?CONTROL.zoom_num.value=t:CONTROL.zoom_bar.value=t)}CONTROL.zoom_bar.addEventListener("input",set_zoom),CONTROL.zoom_num.addEventListener("input",set_zoom),CONTROL.open.onclick=function(e){e.preventDefault(),CONTROL.width.value=CANVAS.width,CONTROL.height.value=CANVAS.height,CONTROL.div.style.display="inline-flex"},CONTROL.close.onclick=function(e){e.preventDefault(),CONTROL.div.style.display="none",CONTROL.outline.style.display="none";const t=ITER.get_params();ITER.set_params(t);let n=!1;CONTROL.new_x==current_params.x_pixels&&CONTROL.new_y==current_params.y_pixels||(n=!0),JSON.stringify(t)!=JSON.stringify(current_params.iter)&&(n=!0),n?(COLOR.update_map(),current_params.x_pixels=CONTROL.new_x,current_params.y_pixels=CONTROL.new_y,current_params.iter=t,render_image(current_params)):recolor()},CONTROL.width.addEventListener("input",resize_canvas_box),CONTROL.height.addEventListener("input",resize_canvas_box);const HELP={div:document.getElementById("help"),open:document.getElementById("help-open"),close:document.getElementById("help-close")};HELP.open.onclick=function(){HELP.div.style.display="inline-block"},HELP.close.onclick=function(){HELP.div.style.display="none"};const RELOAD_WARNING='This annoying "Are you suuuuuure?!?!??" message makes this suck less on mobile.';function annoying_are_you_sure(e){return e.preventDefault(),e.returnValue=RELOAD_WARNING,RELOAD_WARNING}window.addEventListener("beforeunload",annoying_are_you_sure),init();